{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "be4e0513-7571-451e-84c4-5739a973a91e",
   "metadata": {},
   "source": [
    "\n",
    "<!-- ABOUT THE PROJECT -->\n",
    "# ETL with DBT:  `Data Transform`\n",
    "\n",
    "`Data Warehouse:`AWS bicycle company has many locations in various parts of the world. However, their Transactional System (CRM Database) data are stored locally but more importantly the systems are not cross integrated. Another issue is that the CRM is not coordinated with online purchase thus led to following questions below\n",
    "\n",
    "![header](images/logo.png)\n",
    "\n",
    "<details>\n",
    "<summary>\n",
    "    \n",
    "## Questions: Business Intelligence\n",
    "    \n",
    "</summary>\n",
    "        \n",
    "- How can we see FASTER what is happening now? \n",
    "- How is business changing over time? \n",
    "- How can we analyze the data more effectively? \n",
    "- How can we discover what is driving the positive trends? \n",
    "- How can we stop or reverse negative trends? \n",
    " \n",
    "</details>   \n",
    "\n",
    "<details>\n",
    "<summary>\n",
    "    \n",
    "## Reasons: Business Intelligence \n",
    "</summary>\n",
    "    \n",
    "- No consistency in pulling data from transaction system \n",
    "- Difficulty making comparisons and spotting trends over time  \n",
    "- Unable to respond quickly to sales trends or to changing customer behaviors \n",
    "- No Single Source of Truth (SSOT)\n",
    "</details>  \n",
    "\n",
    "<details>\n",
    "<summary>\n",
    "## High Level Solution: Data Architecture\n",
    "</summary>    \n",
    "\n",
    "- Design and develop data warehouse to support sales and marketing \n",
    "- Benefits include consistent reporting available on-demand quickly \n",
    "- Infrastructure will expand in the future to support more subject areas \n",
    "- Manage and Document business processes \n",
    "</details>   \n",
    "\n",
    "***\n",
    "<!-- GETTING STARTED -->\n",
    "## Why should I care about this repo?\n",
    "If you're just starting your cloud data warehouse journey and are hungry to get started with dbt before your organization officially gets a data warehouse, you should check out this repo.\n",
    "\n",
    "If you want to run 28 SQL operations with dbt in less than `1 second`, for free, and all on your local machine, you should check out this repo.\n",
    "![dbt_performance](images/dbt_performance.png)\n",
    "\n",
    "If you want an adrenaline rush from a process that used to take dbt newcomers `1 hour` and is now less than `1 minute`, you should check out this repo.\n",
    "\n",
    "![dbt_full_deploy_commands](images/dbt_full_deploy_commands.png)\n",
    "\n",
    "[Verified GitHub Action on dbt Performance](https://github.com/dbt-labs/jaffle_shop_duckdb/runs/7141529753?check_suite_focus=true#step:4:306)\n",
    "\n",
    "## Running this project\n",
    "***\n",
    "* Prerequisities: Python >= 3.5\n",
    "\n",
    "* [`Snowflake.md`](Starter-Code/Snowflake.sql) -- Level 1 SQL Code.\n",
    "\n",
    "### Mach Speed: No explanation needed\n",
    "\n",
    "> Run `dbt` as fast as possible in a single copy and paste motion!\n",
    "\n",
    "<details open>\n",
    "<summary>Mac Pro</summary>\n",
    "\n",
    "```shell\n",
    "git clone https://github.com/Jayboy628/cloud-snowflake-dbt.git\n",
    "cd cloud-snowflake-dbt\n",
    "python3 -m venv venv\n",
    "source venv/bin/activate\n",
    "python3 -m pip install --upgrade pip\n",
    "pip install dbt-snowflake\n",
    "python3 -m pip install -r requirements.txt\n",
    "source venv/bin/activate\n",
    "dbt build\n",
    "dbt docs generate\n",
    "dbt docs serve\n",
    "```\n",
    "</details>\n",
    "\n",
    "<details>\n",
    "<summary>GitHub Codespaces / Dev Containers </summary>\n",
    "\n",
    "#### Steps\n",
    "a. Create a Snowflake accoumt\n",
    "* [`Snowflake.md`](Starter-Code/Snowflake.sql) -- Level 1 SQL Code.\n",
    "* [`Snowflake.md`](Starter-Code/Snowflake.sql) -- Level 1 SQL Code.\n",
    "* [`Snowflake.md`](Starter-Code/Snowflake.sql) -- Level 1 SQL Code.\n",
    "* [`Snowflake.md`](Starter-Code/Snowflake.sql) -- Level 1 SQL Code.\n",
    "* [`Snowflake.md`](Starter-Code/Snowflake.sql) -- Level 1 SQL Code.\n",
    "\n",
    "1. Ensure you have [Codespaces](https://github.com/features/codespaces) enabled for your GitHub organization or turned on as a beta feature if you're an individual user\n",
    "2. Click the green **Code** button on near the top right of the page of this repo's homepage (you may already be on it)\n",
    "3. Instead of cloning the repo like you normally would, instead select the **Codespaces** tab of the pop out, then \"Create codespace on `duckdb`\"\n",
    "   ![dbt_full_deploy_commands](images/open_in_codespaces.png)\n",
    "4. Wait for codespace to boot (~1 min?)\n",
    "5. Decide whether you'd like to use the Web IDE or open the codespace in your local environment\n",
    "6. When the codespace opens, a Task pane will show up and call `dbt build` just to show you how it's done\n",
    "7. Decide whether or not you'd like the recommended extensions installed (like **dbt Power User extension**)\n",
    "8. Open up a new terminal and type:\n",
    "    ```\n",
    "    dbt build\n",
    "    ```\n",
    "9. Explore some of the bells and whistles (see below)\n",
    "\n",
    "If you don't have Codespaces or would like to just run the environment in a local Docker container, you can by:\n",
    "1. Install [Docker Desktop](https://www.docker.com/products/docker-desktop/)\n",
    "2. Install the VSCode [Dev Containers](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) extension (formerly known as the \"Remote - Containers\" extension). Video tutorial [here](https://learn.microsoft.com/en-us/shows/beginners-series-to-dev-containers/installing-the-remote-containers-extension-2-of-8--beginners-series-to-dev-containers).\n",
    "2. Clone this repo and open it in VSCode\n",
    "1. First time: View > Command Palette > Remote-Containers: Open Folder in Container\n",
    "    - Wait for container to build -- expected to take several minutes\n",
    "    - Open a new terminal\n",
    "3. Subsequent times: Click **Reopen in Container** and wait for container to spin up\n",
    "   ![Reopen in Container](https://user-images.githubusercontent.com/8158673/181360469-c6f3eb94-6b65-4a8f-93a0-3438d182ee66.png)\n",
    "1. Continue on step 7 above\n",
    "\n",
    "\n",
    "#### bells and whistles\n",
    "\n",
    "There's some bells and whistles defined in the [.devcontainer.json]().devcontainer.json) that are worth calling out. Also a great reference is the [Setting up VSCode for dbt](https://dbt-msft.github.io/dbt-msft-docs/docs/guides/vscode_setup/) guide.\n",
    "\n",
    "1. there is syntax highlighting provided by the `vdcode-dbt` extension. However, it is configured such that files in your `target/run` and `target/compiled` folder are not syntax highlighted, as a reminder that these files are not where you should be making changes!\n",
    "2. basic `sqlfluff` linting is enabled as you type. Syntax errors will be underlined in red at the error, and will also be surfaced in the **Problems** tab of the Terminal pane. It's configured to lint as you type.\n",
    "3. Autocompletion is enabled for generic dbt macros via the `vdcode-dbt` extension. For example, if you type `macro` you'll notice a pop up that you can select with the arrow keys then click tab to get a macro snippet.\n",
    "  ![image](https://user-images.githubusercontent.com/8158673/181362230-2c00d666-6131-4619-93aa-2e30d9c2bfea.png)\n",
    "  ![image](https://user-images.githubusercontent.com/8158673/181362274-fa7d71ff-07fc-4b4a-97c3-a0464fbe4c7d.png)\n",
    "4. the `find-related` extension allows an easy shortcut to navigating using `CMD`+`R`to jump from\n",
    "    - a model file to it's corresponding compiled version,\n",
    "    - from a compiled file to either the original model file or the version in `target/run`\n",
    "5. The `vscode-yaml` YAML, combined with the JSON schema defined in [dbt-labs/dbt-jsonschema](https://github.com/dbt-labs/dbt-jsonschema), autocomplete options while working with dbt's YAML files: i.e. :\n",
    "    - Project definition files (`dbt_project.yml`)\n",
    "    - Package files (`packages.yml`)\n",
    "    - Selectors files (`selectors.yml`)\n",
    "    - Property files (`models/whatever.yml`)\n",
    "\n",
    "\n",
    "\n",
    "</details>\n",
    "\n",
    "### Step-by-step explanation\n",
    "\n",
    "To get up and running with this project:\n",
    "\n",
    "1. Clone this repository.\n",
    "\n",
    "1. Change into the `jaffle_shop_duck` directory from the command line:\n",
    "    ```shell\n",
    "    cd jaffle_shop_duckdb\n",
    "    ```\n",
    "\n",
    "1. Install dbt and DuckDB in a virtual environment.\n",
    "\n",
    "    Expand your shell below:\n",
    "\n",
    "    <details open>\n",
    "    <summary>POSIX bash/zsh</summary>\n",
    "\n",
    "    ```shell\n",
    "    python3 -m venv venv\n",
    "    source venv/bin/activate\n",
    "    python3 -m pip install --upgrade pip\n",
    "    python3 -m pip install -r requirements.txt\n",
    "    source venv/bin/activate\n",
    "    ```\n",
    "    </details>\n",
    "\n",
    "\n",
    "    *Why a 2nd activation of the virtual environment?*\n",
    "    <details>\n",
    "    <summary>This may not be necessary for many users, but might be for some. Read on for a first-person report from @dbeatty10.</summary>\n",
    "\n",
    "    I use `zsh` as my shell on my MacBook Pro, and I use `pyenv` to manage my Python environments. I already had an alpha version of dbt Core 1.2 installed (and yet another via [pipx](https://pypa.github.io/pipx/installation/)):\n",
    "    ```shell\n",
    "    $ which dbt\n",
    "    /Users/dbeatty/.pyenv/shims/dbt\n",
    "    ```\n",
    "    ```shell\n",
    "    $ dbt --version\n",
    "    Core:\n",
    "      - installed: 1.2.0-a1\n",
    "      - latest:    1.1.1    - Ahead of latest version!\n",
    "\n",
    "    Plugins:\n",
    "      - bigquery:  1.2.0a1 - Ahead of latest version!\n",
    "      - snowflake: 1.2.0a1 - Ahead of latest version!\n",
    "      - redshift:  1.2.0a1 - Ahead of latest version!\n",
    "      - postgres:  1.2.0a1 - Ahead of latest version!\n",
    "    ```\n",
    "\n",
    "    Then I ran all the steps to create a virtual environment and install the requirements of our DuckDB-based Jaffle Shop repo:\n",
    "    ```shell\n",
    "    $ python3 -m venv venv\n",
    "    $ source venv/bin/activate\n",
    "    (venv) $ python3 -m pip install --upgrade pip\n",
    "    (venv) $ python3 -m pip install -r requirements.txt\n",
    "    ```\n",
    "\n",
    "    Let's examine where `dbt` is installed and which version it is reporting:\n",
    "    ```shell\n",
    "    (venv) $ which dbt\n",
    "    /Users/dbeatty/projects/jaffle_duck/venv/bin/dbt\n",
    "    ```\n",
    "\n",
    "    ```shell\n",
    "    (venv) $ dbt --version\n",
    "    Core:\n",
    "      - installed: 1.2.0-a1\n",
    "      - latest:    1.1.1    - Ahead of latest version!\n",
    "\n",
    "    Plugins:\n",
    "      - bigquery:  1.2.0a1 - Ahead of latest version!\n",
    "      - snowflake: 1.2.0a1 - Ahead of latest version!\n",
    "      - redshift:  1.2.0a1 - Ahead of latest version!\n",
    "      - postgres:  1.2.0a1 - Ahead of latest version!\n",
    "    ```\n",
    "\n",
    "    ‚ùå That isn't what we expected -- something isn't right. üò¢\n",
    "\n",
    "    So let's reactivate the virtual environment and try again...\n",
    "    ```shell\n",
    "    (venv) $ source venv/bin/activate\n",
    "    ```\n",
    "\n",
    "    ```shell\n",
    "    (venv) $ dbt --version\n",
    "    Core:\n",
    "      - installed: 1.1.1\n",
    "      - latest:    1.1.1 - Up to date!\n",
    "\n",
    "    Plugins:\n",
    "      - postgres: 1.1.1 - Up to date!\n",
    "      - duckdb:   1.1.3 - Up to date!\n",
    "    ```\n",
    "\n",
    "    ‚úÖ This is what we want -- the 2nd reactivation worked. üòé \n",
    "    </details>\n",
    "\n",
    "1. Ensure your [profile](https://docs.getdbt.com/reference/profiles.yml) is setup correctly from the command line:\n",
    "    ```shell\n",
    "    dbt --version\n",
    "    dbt debug\n",
    "    ```\n",
    "\n",
    "1. Load the CSVs with the demo data set, run the models, and test the output of the models using the [dbt build](https://docs.getdbt.com/reference/commands/build) command:\n",
    "    ```shell\n",
    "    dbt build\n",
    "    ```\n",
    "\n",
    "1. Query the data:\n",
    "\n",
    "    Launch a DuckDB command-line interface (CLI):\n",
    "    ```shell\n",
    "    duckcli jaffle_shop.duckdb\n",
    "    ```\n",
    "\n",
    "    Run a query at the prompt and exit:\n",
    "    ```\n",
    "    select * from customers where customer_id = 42;\n",
    "    exit;\n",
    "    ```\n",
    "\n",
    "    Alternatively, use a single-liner to perform the query:\n",
    "    ```shell\n",
    "    duckcli jaffle_shop.duckdb -e \"select * from customers where customer_id = 42\"\n",
    "    ```\n",
    "    or:\n",
    "    ```shell\n",
    "    echo 'select * from customers where customer_id = 42' | duckcli jaffle_shop.duckdb\n",
    "    ```\n",
    "\n",
    "1. Generate and view the documentation for the project:\n",
    "    ```shell\n",
    "    dbt docs generate\n",
    "    dbt docs serve\n",
    "    ```\n",
    "\n",
    "## Running `build` steps independently\n",
    "\n",
    "1. Load the CSVs with the demo data set. This materializes the CSVs as tables in your target schema. Note that a typical dbt project **does not require this step** since dbt assumes your raw data is already in your warehouse.\n",
    "    ```shell\n",
    "    dbt seed\n",
    "    ```\n",
    "\n",
    "1. Run the models:\n",
    "    ```shell\n",
    "    dbt run\n",
    "    ```\n",
    "\n",
    "    > **NOTE:** If you decide to run this project in your own data warehouse (outside of this DuckDB demo) and steps fail, it might mean that you need to make small changes to the SQL in the models folder to adjust for the flavor of SQL of your target database. Definitely consider this if you are using a community-contributed adapter.\n",
    "\n",
    "1. Test the output of the models using the [test](https://docs.getdbt.com/reference/commands/test) command:\n",
    "    ```shell\n",
    "    dbt test\n",
    "    ```\n",
    "\n",
    "## Browsing the data\n",
    "Some options:\n",
    "- [duckcli](https://pypi.org/project/duckcli/)\n",
    "- [DuckDB CLI](https://duckdb.org/docs/installation/?environment=cli)\n",
    "- [How to set up DBeaver SQL IDE for DuckDB](https://duckdb.org/docs/guides/sql_editors/dbeaver)\n",
    "\n",
    "### Troubleshooting\n",
    "\n",
    "You may get an error like this, in which case you will need to disconnect from any sessions that are locking the database:\n",
    "```\n",
    "IO Error: Could not set lock on file \"jaffle_shop.duckdb\": Resource temporarily unavailable\n",
    "```\n",
    "\n",
    "This is a known issue in DuckDB. If you are using DBeaver, this means shutting down DBeaver (merely disconnecting didn't work for me).\n",
    "\n",
    "Very worst-case, deleting the database file will get you back in action (BUT you will lose all your data).\n",
    "\n",
    "\n",
    "#### GitHub Codespaces and VSCode Remote Container\n",
    "\n",
    "If you're using a privacy-forward browser such as Firefox and Brave, or a tracking-cookie-blocking extension like UBlock Origin or Privacy Badger, you may see the below error. You can either change your cookie settings, use a browser like Chrome, or just ignore the error because it doesn't affect the demo\n",
    "\n",
    "![image](https://user-images.githubusercontent.com/8158673/181361459-294f807c-d990-4366-a4ab-d91cefcbc820.png)\n",
    "\n",
    "---\n",
    "For more information on dbt:\n",
    "- Read the [introduction to dbt](https://docs.getdbt.com/docs/introduction)\n",
    "- Read the [dbt viewpoint](https://docs.getdbt.com/docs/about/viewpoint)\n",
    "- Join the [dbt Community](http://community.getdbt.com/)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "8ae95dd9-df47-4160-8bbd-a5260c7797ae",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.9.10"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
